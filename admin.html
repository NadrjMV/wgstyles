<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WG.Styles | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { black: '#0a0a0a', dark: '#121212', gray: '#27272a', accent: '#3b82f6' } } // Accent blue pra edição
                }
            }
        }
    </script>
    <style>
        body { background-color: #0a0a0a; color: #f4f4f5; }
        .glass { background: rgba(18, 18, 18, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col items-center justify-center relative">

    <div id="login-screen" class="w-full max-w-md p-8 glass rounded-sm z-50">
        <h2 class="text-2xl font-bold text-center mb-6 text-white uppercase italic">Acesso Admin</h2>
        <form id="login-form" class="space-y-4">
            <input type="email" id="email" placeholder="Email" class="w-full bg-brand-black border border-gray-700 p-3 text-white focus:outline-none focus:border-white transition" required>
            <input type="password" id="password" placeholder="Senha" class="w-full bg-brand-black border border-gray-700 p-3 text-white focus:outline-none focus:border-white transition" required>
            <button type="submit" class="w-full bg-white text-black font-bold py-3 hover:bg-gray-200 transition">ENTRAR</button>
        </form>
    </div>

    <div id="dashboard" class="hidden w-full max-w-6xl mx-auto p-4 sm:p-8">
        <header class="flex justify-between items-center mb-10 border-b border-gray-800 pb-4">
            <h1 class="text-3xl font-bold uppercase italic">Painel de Controle</h1>
            <button id="logout-btn" class="text-red-500 hover:text-red-400 font-bold text-sm uppercase">Sair</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="glass p-6 rounded-sm sticky top-8 border-l-4 border-l-transparent transition-all" id="form-container">
                    <h3 class="text-xl font-bold mb-4" id="form-title">Novo Item</h3>
                    
                    <form id="product-form" class="space-y-4">
                        <input type="hidden" id="edit-id"> <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Nome</label>
                            <input type="text" id="p-name" class="w-full bg-brand-black border border-gray-700 p-3 text-white focus:border-white outline-none" required>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Preço</label>
                            <input type="text" id="p-price" class="w-full bg-brand-black border border-gray-700 p-3 text-white focus:border-white outline-none" placeholder="R$ 00,00" required>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Categoria</label>
                            <select id="p-category" class="w-full bg-brand-black border border-gray-700 p-3 text-white focus:border-white outline-none">
                                <option value="clothing">Streetwear (Roupas)</option>
                                <option value="silver">Pratas</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Foto</label>
                            <input type="file" id="p-file" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-800 file:text-white hover:file:bg-gray-700 cursor-pointer">
                            <p class="text-[10px] text-gray-500 mt-2" id="file-help-text">A imagem será comprimida automaticamente.</p>
                        </div>

                        <div class="flex gap-2 pt-4">
                            <button type="submit" class="flex-1 bg-white text-black font-bold py-3 hover:bg-gray-200 transition" id="submit-btn">
                                SALVAR
                            </button>
                            <button type="button" onclick="cancelEditMode()" id="cancel-btn" class="hidden px-4 border border-gray-600 text-gray-400 hover:text-white hover:border-white transition font-bold">
                                X
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <h3 class="text-xl font-bold mb-4">Catálogo</h3>
                <div id="products-list" class="grid grid-cols-1 gap-3">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Adicionamos 'updateDoc' nos imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCT1O19PyNwADsuvZSDDRhOQY8TqyIItBk",
            authDomain: "wgstyle-b3e7c.firebaseapp.com",
            projectId: "wgstyle-b3e7c",
            storageBucket: "wgstyle-b3e7c.firebasestorage.app",
            messagingSenderId: "369964929983",
            appId: "1:369964929983:web:01c66ff0047d3521df470a",
            measurementId: "G-04Y2BMGMR3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referências
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const productForm = document.getElementById('product-form');
        const productsList = document.getElementById('products-list');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const formTitle = document.getElementById('form-title');
        const editIdInput = document.getElementById('edit-id');
        const formContainer = document.getElementById('form-container');

        // Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                loadProducts();
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => alert("Erro: " + err.message));
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- COMPRESSÃO BASE64 ---
        function compressAndConvert(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; // Limite de largura
                        const scaleSize = maxWidth / img.width;
                        if (scaleSize < 1) {
                            canvas.width = maxWidth;
                            canvas.height = img.height * scaleSize;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Qualidade 0.7 = bom equilíbrio
                        const base64String = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(base64String);
                    }
                    img.onerror = reject;
                }
                reader.onerror = reject;
            });
        }

        // --- SALVAR / ATUALIZAR ---
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = document.getElementById('p-file').files[0];
            const isEditing = editIdInput.value !== ""; // Verifica se tem ID no campo hidden

            // Validação: Se for criar novo, TEM que ter foto. Se for editar, foto é opcional.
            if (!isEditing && !file) {
                return alert("Para criar um novo item, selecione uma foto.");
            }

            submitBtn.disabled = true;
            submitBtn.innerText = isEditing ? "ATUALIZANDO..." : "SALVANDO...";

            try {
                let imgData = null;

                // Só processa imagem se o usuário escolheu uma nova
                if (file) {
                    imgData = await compressAndConvert(file);
                }

                if (isEditing) {
                    // --- MODO EDIÇÃO ---
                    const updateData = {
                        name: document.getElementById('p-name').value,
                        price: document.getElementById('p-price').value,
                        category: document.getElementById('p-category').value
                    };
                    // Só adiciona imagem ao update se ela mudou
                    if (imgData) {
                        updateData.img = imgData;
                    }

                    await updateDoc(doc(db, "products", editIdInput.value), updateData);
                    alert("Produto atualizado!");
                    cancelEditMode(); // Reseta o form

                } else {
                    // --- MODO CRIAÇÃO ---
                    await addDoc(collection(db, "products"), {
                        name: document.getElementById('p-name').value,
                        price: document.getElementById('p-price').value,
                        category: document.getElementById('p-category').value,
                        img: imgData,
                        createdAt: new Date()
                    });
                    productForm.reset();
                    alert("Criado com sucesso!");
                }

            } catch (err) {
                console.error(err);
                alert("Erro: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = isEditing ? "ATUALIZAR ITEM" : "CADASTRAR";
            }
        });

        // --- FUNÇÕES DE CONTROLE DE EDIÇÃO ---
        
        // Ativada ao clicar no lápis
        window.startEdit = (id, name, price, category) => {
            // 1. Preenche o form
            editIdInput.value = id;
            document.getElementById('p-name').value = name;
            document.getElementById('p-price').value = price;
            document.getElementById('p-category').value = category;

            // 2. Muda UI
            formTitle.innerText = "Editando Item";
            submitBtn.innerText = "ATUALIZAR ITEM";
            submitBtn.classList.replace('bg-white', 'bg-blue-600'); // Muda cor pra azul
            submitBtn.classList.replace('text-black', 'text-white');
            
            cancelBtn.classList.remove('hidden'); // Mostra botão cancelar
            formContainer.classList.add('border-l-blue-600'); // Destaque lateral
            
            document.getElementById('file-help-text').innerText = "Deixe vazio para manter a foto atual.";
            
            // 3. Rola a tela pra cima (Mobile UX)
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Ativada ao clicar no X ou após salvar
        window.cancelEditMode = () => {
            productForm.reset();
            editIdInput.value = ""; // Limpa ID
            
            formTitle.innerText = "Novo Item";
            submitBtn.innerText = "SALVAR";
            submitBtn.classList.replace('bg-blue-600', 'bg-white');
            submitBtn.classList.replace('text-white', 'text-black');
            
            cancelBtn.classList.add('hidden');
            formContainer.classList.remove('border-l-blue-600');
            
            document.getElementById('file-help-text').innerText = "A imagem será comprimida automaticamente.";
        }

        // Listar
        function loadProducts() {
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                productsList.innerHTML = "";
                snapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    // Escapando aspas pra não quebrar o HTML na função onclick
                    const safeName = p.name.replace(/'/g, "\\'"); 
                    
                    const card = `
                        <div class="glass p-3 rounded-sm flex gap-4 items-center">
                            <img src="${p.img}" class="w-14 h-14 object-cover rounded-sm bg-gray-800">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white truncate text-sm">${p.name}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <p class="text-xs text-gray-400 font-mono">${p.price}</p>
                                    <span class="text-[10px] bg-gray-800 px-2 rounded text-gray-500 border border-gray-700">${p.category}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="window.startEdit('${docSnap.id}', '${safeName}', '${p.price}', '${p.category}')" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-blue-600 hover:text-white transition flex items-center justify-center text-gray-400">
                                    <i class="ph ph-pencil-simple text-lg"></i>
                                </button>
                                <button onclick="window.deleteProduct('${docSnap.id}')" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-600 hover:text-white transition flex items-center justify-center text-gray-400">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    productsList.innerHTML += card;
                });
            });
        }

        window.deleteProduct = async (id) => {
            if(confirm("Tem certeza que deseja excluir?")) await deleteDoc(doc(db, "products", id));
        }
    </script>
</body>
</html>